// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USERS ====================

model User {
  id              String    @id // Firebase UID
  email           String    @unique
  fullName        String?
  phone           String?
  photoUrl        String?
  calendarColor   String?
  activeFamilyId  String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  ownedFamilies     Family[]        @relation("FamilyOwner")
  familyMemberships FamilyMember[]
  pushTokens        PushToken[]
  createdExpenses   Expense[]       @relation("ExpenseCreator")
  updatedExpenses   Expense[]       @relation("ExpenseUpdater")
  createdTasks      Task[]          @relation("TaskCreator")
  completedTasks    Task[]          @relation("TaskCompleter")
  createdEvents     CalendarEvent[] @relation("EventCreator")
  uploadedDocuments Document[]      @relation("DocumentUploader")
  sentSwapRequests  SwapRequest[]   @relation("SwapRequester")
  receivedSwapRequests SwapRequest[] @relation("SwapResponder")
  chatMessages      ChatMessage[]
  paymentReceipts   PaymentReceipt[] @relation("PaymentReceiptUploader")
  notifications        Notification[]
  notificationPreferences NotificationPreferences?
  userSettings         UserSettings?
  privacySettings      PrivacySettings?

  @@index([email])
  @@index([activeFamilyId])
}

model PushToken {
  id        String   @id @default(uuid())
  token     String   @unique
  platform  String?  // web, ios, android
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// ==================== FAMILIES ====================

model Family {
  id                 String    @id @default(uuid())
  name               String?
  photoUrl           String?
  shareCode          String?   @unique
  shareCodeUpdatedAt DateTime?
  ownerId            String
  owner              User      @relation("FamilyOwner", fields: [ownerId], references: [id])
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // Relations
  members          FamilyMember[]
  children         FamilyChild[]
  invites          FamilyInvite[]
  expenses         Expense[]
  tasks            Task[]
  calendarEvents   CalendarEvent[]
  documents        Document[]
  swapRequests     SwapRequest[]
  chatMessages      ChatMessage[]
  paymentReceipts   PaymentReceipt[]
  custodySchedule   CustodySchedule?
  custodyOverrides  CustodyOverride[]
  financeSettings   FinanceSettings?
  eventReminders    EventReminder[]
  goalTables       GoalTable[]
  notifications    Notification[]
  familySettings   FamilySettings?
  monthlySummaries  MonthlyExpenseSummary[]

  @@index([ownerId])
  @@index([shareCode])
}

model FamilyMember {
  id        String   @id @default(uuid())
  familyId  String
  userId    String
  role      String   @default("member") // owner, member
  joinedAt  DateTime @default(now())

  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([familyId, userId])
  @@index([familyId])
  @@index([userId])
}

model FamilyChild {
  id        String   @id @default(uuid())
  familyId  String
  name      String
  birthDate DateTime?
  photoUrl  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@index([familyId])
}

model FamilyInvite {
  id            String   @id @default(uuid())
  familyId      String
  email         String
  displayEmail  String   // Original casing
  invitedById   String
  invitedByName String?
  status        String   @default("pending") // pending, accepted, expired
  createdAt     DateTime @default(now())
  expiresAt     DateTime?

  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@unique([familyId, email])
  @@index([email])
  @@index([familyId])
}

// ==================== NOTIFICATIONS ====================

model Notification {
  id        String   @id @default(uuid())
  userId    String
  familyId  String?
  type      String
  title     String
  body      String
  priority  String   @default("normal")
  data      Json?
  actionUrl String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  family Family? @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([familyId])
  @@index([userId, read])
  @@index([createdAt])
}

model NotificationPreferences {
  id                     String   @id @default(uuid())
  userId                 String   @unique
  expenseNotifications   Boolean  @default(true)
  swapRequestNotifications Boolean @default(true)
  taskNotifications      Boolean  @default(true)
  calendarNotifications  Boolean  @default(true)
  chatNotifications      Boolean  @default(true)
  emailNotifications     Boolean  @default(true)
  pushNotifications      Boolean  @default(true)
  quietHoursEnabled      Boolean  @default(false)
  quietHoursStart        String?
  quietHoursEnd          String?
  updatedAt              DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ==================== SETTINGS ====================

model UserSettings {
  id         String   @id @default(uuid())
  userId     String   @unique
  language   String   @default("en")
  timezone   String   @default("UTC")
  dateFormat String   @default("MM/DD/YYYY")
  timeFormat String   @default("12h")
  weekStart  String   @default("sunday")
  theme      String   @default("auto")
  updatedAt  DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model FamilySettings {
  id                         String   @id @default(uuid())
  familyId                   String   @unique
  defaultCurrency            String   @default("USD")
  expenseSplitDefault        String   @default("equal")
  parent1Percentage          Int      @default(50)
  parent2Percentage          Int      @default(50)
  requireApprovalForExpenses Boolean  @default(true)
  expenseApprovalThreshold   Float?
  allowSwapRequests          Boolean  @default(true)
  requireApprovalForSwaps    Boolean  @default(true)
  reminderDefaultTime        String   @default("09:00")
  enableCalendarReminders    Boolean  @default(true)
  calendarReminderMinutes    Int      @default(30)
  updatedAt                  DateTime @updatedAt

  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@index([familyId])
}

model PrivacySettings {
  id                      String   @id @default(uuid())
  userId                  String   @unique
  profileVisibility       String   @default("family")
  shareCalendarWithCoParent Boolean @default(true)
  shareExpensesWithCoParent Boolean @default(true)
  shareDocumentsWithCoParent Boolean @default(true)
  allowCoParentMessaging  Boolean  @default(true)
  blockedUserIds          String[] @default([])
  updatedAt               DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ==================== CUSTODY ====================

model CustodySchedule {
  id                     String    @id @default(uuid())
  familyId               String    @unique
  name                   String?
  pattern                String    // weekly, biweekly, custom, week_on_week_off
  startDate              DateTime
  endDate                DateTime?
  parent1Days            Int[]     // 0-6 (Sun-Sat)
  parent2Days            Int[]
  biweeklyAltParent1Days Int[]     @default([])
  biweeklyAltParent2Days Int[]     @default([])
  isActive               Boolean   @default(true)
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  family          Family                   @relation(fields: [familyId], references: [id], onDelete: Cascade)
  pendingApproval CustodyApprovalRequest?
}

model CustodyApprovalRequest {
  id              String   @id @default(uuid())
  scheduleId      String   @unique
  name            String?
  pattern         String
  startDate       DateTime
  parent1Days     Int[]
  parent2Days     Int[]
  requestedById   String?
  requestedByName String?
  requestedAt     DateTime @default(now())

  schedule CustodySchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
}

model CustodyOverride {
  id              String    @id @default(uuid())
  familyId        String
  name            String?
  type            String    // vacation, holiday, special, swap
  startDate       DateTime
  endDate         DateTime
  assignments     Json      // { "2024-01-15": "parent1", "2024-01-16": "parent2" }
  note            String?
  status          String    @default("pending") // pending, approved, rejected, cancelled
  requestedById   String
  requestedByName String?
  requestedToId   String?
  requestedToName String?
  responseNote    String?
  respondedById   String?
  respondedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@index([familyId])
  @@index([familyId, status])
  @@index([familyId, startDate, endDate])
}

// ==================== CALENDAR ====================

model CalendarEvent {
  id              String    @id @default(uuid())
  familyId        String
  title           String
  description     String?
  startDate       DateTime
  endDate         DateTime
  type            String    // custody, pickup, dropoff, school, activity, medical, holiday, vacation, other
  parentId        String    // parent1, parent2, both
  targetUids      String[]  @default([])
  color           String?
  location        String?
  reminderMinutes Int?
  isAllDay        Boolean   @default(false)
  childId         String?
  swapRequestId   String?
  createdById     String?
  createdByName   String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  family    Family          @relation(fields: [familyId], references: [id], onDelete: Cascade)
  createdBy User?           @relation("EventCreator", fields: [createdById], references: [id], onDelete: SetNull)
  reminder  EventReminder?

  @@index([familyId])
  @@index([familyId, startDate])
  @@index([swapRequestId])
}

model EventReminder {
  id        String    @id @default(uuid())
  eventId   String    @unique
  familyId  String
  title     String
  startDate DateTime
  sendAt    DateTime
  sent      Boolean   @default(false)
  sentAt    DateTime?
  targetUids String[] @default([])
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  event  CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  family Family        @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@index([sent, sendAt])
  @@index([familyId])
}

// ==================== EXPENSES ====================

model Expense {
  id             String    @id @default(uuid())
  familyId       String
  title          String
  amount         Float
  date           DateTime
  notes          String?
  receiptUrl     String?
  receiptName    String?
  splitParent1   Int       @default(50) // percentage 0-100
  status         String    @default("pending") // pending, approved, rejected
  isPaid         Boolean   @default(false)
  createdById    String
  createdByName  String?
  updatedById    String?
  updatedByName  String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  family    Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  createdBy User   @relation("ExpenseCreator", fields: [createdById], references: [id], onDelete: Cascade)
  updatedBy User?  @relation("ExpenseUpdater", fields: [updatedById], references: [id], onDelete: SetNull)

  @@index([familyId])
  @@index([familyId, date])
  @@index([familyId, status])
}

model FinanceSettings {
  id                     String   @id @default(uuid())
  familyId               String   @unique
  alimonyAmount          Float    @default(0)
  alimonyPayer           String?  // parent1, parent2, null
  defaultSplitParent1    Int      @default(50)
  defaultExpenseCategory String?
  enableReceiptScanning  Boolean  @default(true)
  autoCalculateSplit     Boolean  @default(true)
  trackPaymentStatus     Boolean  @default(true)
  sendPaymentReminders   Boolean  @default(true)
  paymentReminderDays    Int      @default(7)
  updatedAt              DateTime @updatedAt

  family        Family         @relation(fields: [familyId], references: [id], onDelete: Cascade)
  fixedExpenses FixedExpense[]
}

model FixedExpense {
  id           String @id @default(uuid())
  settingsId   String
  title        String
  amount       Float
  splitParent1 Int

  settings FinanceSettings @relation(fields: [settingsId], references: [id], onDelete: Cascade)

  @@index([settingsId])
}

// ==================== TASKS ====================

model Task {
  id            String    @id @default(uuid())
  familyId      String
  title         String
  description   String?
  dueDate       DateTime?
  priority      String    @default("medium") // low, medium, high, urgent
  status        String    @default("pending") // pending, in_progress, completed, cancelled
  assignedTo    String    @default("both") // parent1, parent2, both
  category      String    @default("other") // medical, education, activity, shopping, household, paperwork, other
  childId       String?
  createdById   String
  createdByName String?
  completedAt   DateTime?
  completedById String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  family      Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  createdBy   User   @relation("TaskCreator", fields: [createdById], references: [id], onDelete: Cascade)
  completedBy User?  @relation("TaskCompleter", fields: [completedById], references: [id], onDelete: SetNull)

  @@index([familyId])
  @@index([familyId, status])
  @@index([familyId, dueDate])
}

// ==================== DOCUMENTS ====================

model Document {
  id             String   @id @default(uuid())
  familyId       String
  title          String
  fileName       String
  fileUrl        String   // S3/Cloudinary URL
  fileSize       Int?     // in bytes
  mimeType       String?
  childId        String?
  uploadedById   String?
  uploadedByName String?
  uploadedAt     DateTime @default(now())

  family     Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  uploadedBy User?  @relation("DocumentUploader", fields: [uploadedById], references: [id], onDelete: SetNull)

  @@index([familyId])
  @@index([familyId, childId])
}

// ==================== SWAP REQUESTS ====================

model SwapRequest {
  id                   String    @id @default(uuid())
  familyId             String
  requestedById        String
  requestedByName      String?
  requestedToId        String
  requestedToName      String?
  originalDate         DateTime
  proposedDate         DateTime?
  previousProposedDate DateTime?  // Store original proposed date when countered
  requestType          String    @default("swap") // swap, one-way
  reason               String?
  status               String    @default("pending") // pending, approved, rejected, cancelled, countered, final_pending
  responseNote         String?
  respondedAt          DateTime?
  // Counter flow fields
  counteredById        String?
  counterNote          String?
  counteredAt          DateTime?
  counterResponseNote  String?
  counterRespondedAt   DateTime?
  requesterConfirmedAt DateTime?
  createdAt            DateTime  @default(now())

  family      Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  requestedBy User   @relation("SwapRequester", fields: [requestedById], references: [id], onDelete: Cascade)
  requestedTo User   @relation("SwapResponder", fields: [requestedToId], references: [id], onDelete: Cascade)

  @@index([familyId])
  @@index([familyId, status])
  @@index([requestedById])
  @@index([requestedToId])
}

// ==================== PAYMENT RECEIPTS ====================

model PaymentReceipt {
  id            String   @id @default(uuid())
  familyId      String
  month         Int      // 0-11
  year          Int
  imageUrl      String   // Base64 or S3 URL
  imageName     String?
  amount        Float?
  paidTo        String   // parent1, parent2
  description   String?
  uploadedById  String
  uploadedByName String?
  createdAt     DateTime @default(now())

  family     Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  uploadedBy User   @relation("PaymentReceiptUploader", fields: [uploadedById], references: [id], onDelete: Cascade)

  @@index([familyId])
  @@index([familyId, year, month])
}

// ==================== CHAT ====================

model ChatMessage {
  id          String    @id @default(uuid())
  familyId    String
  senderId    String
  senderName  String?
  text        String?
  
  // Image support
  imageData   String?   // Base64 encoded image
  imageWidth  Int?
  imageHeight Int?
  
  // Edit/Delete support
  edited      Boolean   @default(false)
  editedAt    DateTime?
  deleted     Boolean   @default(false)
  deletedAt   DateTime?
  
  sentAt      DateTime  @default(now())

  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  sender User   @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([familyId, sentAt])
  @@index([senderId])
}

// ==================== GOALS ====================

model GoalTable {
  id        String   @id @default(uuid())
  familyId  String
  childId   String   // Reference to FamilyChild
  childName String
  title     String
  startDate DateTime
  endDate   DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  family   Family         @relation(fields: [familyId], references: [id], onDelete: Cascade)
  goals    Goal[]
  progress DailyProgress[]

  @@index([familyId])
  @@index([familyId, childId])
  @@index([familyId, startDate, endDate])
}

model Goal {
  id          String    @id @default(uuid())
  goalTableId String
  title       String
  icon        String?
  order       Int       @default(0)

  goalTable GoalTable @relation(fields: [goalTableId], references: [id], onDelete: Cascade)

  @@index([goalTableId])
}

model DailyProgress {
  id                   String   @id @default(uuid())
  goalTableId          String
  date                 DateTime // Date only (no time)
  completedGoals       String[] // Array of Goal IDs
  notes                String?
  completionPercentage Int      @default(0)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  goalTable GoalTable @relation(fields: [goalTableId], references: [id], onDelete: Cascade)

  @@unique([goalTableId, date])
  @@index([goalTableId, date])
}

// ==================== MONTHLY SUMMARIES ====================

model MonthlyExpenseSummary {
  id            String   @id @default(uuid())
  familyId      String
  month         Int      // 0-11
  year          Int
  label         String   // "ינואר 2024"
  totalApproved Float    @default(0)
  parent1Share  Float    @default(0)
  parent2Share  Float    @default(0)
  approvedCount Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@unique([familyId, year, month])
  @@index([familyId])
  @@index([familyId, year])
}
