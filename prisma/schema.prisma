generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model User {
  id                      String                   @id
  email                   String                   @unique
  fullName                String?
  phone                   String?
  photoUrl                String?
  calendarColor           String?
  activeFamilyId          String?
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  createdEvents           CalendarEvent[]          @relation("EventCreator")
  chatMessages            ChatMessage[]
  uploadedDocuments       Document[]               @relation("DocumentUploader")
  createdExpenses         Expense[]                @relation("ExpenseCreator")
  updatedExpenses         Expense[]                @relation("ExpenseUpdater")
  ownedFamilies           Family[]                 @relation("FamilyOwner")
  familyMemberships       FamilyMember[]
  notifications           Notification[]
  notificationPreferences NotificationPreferences?
  paymentReceipts         PaymentReceipt[]         @relation("PaymentReceiptUploader")
  privacySettings         PrivacySettings?
  pushTokens              PushToken[]
  sentSwapRequests        SwapRequest[]            @relation("SwapRequester")
  receivedSwapRequests    SwapRequest[]            @relation("SwapResponder")
  completedTasks          Task[]                   @relation("TaskCompleter")
  createdTasks            Task[]                   @relation("TaskCreator")
  userSettings            UserSettings?

  @@index([email])
  @@index([activeFamilyId])
}

model PushToken {
  id        String   @id @default(uuid())
  token     String   @unique
  platform  String?
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Family {
  id                 String                  @id @default(uuid())
  name               String?
  photoUrl           String?
  shareCode          String?                 @unique
  shareCodeUpdatedAt DateTime?
  ownerId            String
  createdAt          DateTime                @default(now())
  updatedAt          DateTime                @updatedAt
  calendarEvents     CalendarEvent[]
  chatMessages       ChatMessage[]
  contacts           Contact[]
  custodyOverrides   CustodyOverride[]
  custodySchedule    CustodySchedule?
  documents          Document[]
  eventReminders     EventReminder[]
  expenses           Expense[]
  owner              User                    @relation("FamilyOwner", fields: [ownerId], references: [id])
  children           FamilyChild[]
  invites            FamilyInvite[]
  members            FamilyMember[]
  familySettings     FamilySettings?
  financeSettings    FinanceSettings?
  goalTables         GoalTable[]
  monthlySummaries   MonthlyExpenseSummary[]
  notifications      Notification[]
  paymentReceipts    PaymentReceipt[]
  swapRequests       SwapRequest[]
  tasks              Task[]

  @@index([ownerId])
  @@index([shareCode])
}

model FamilyMember {
  id       String   @id @default(uuid())
  familyId String
  userId   String
  role     String   @default("member")
  joinedAt DateTime @default(now())
  family   Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([familyId, userId])
  @@index([familyId])
  @@index([userId])
}

model FamilyChild {
  id         String    @id @default(uuid())
  familyId   String
  name       String
  birthDate  DateTime?
  photoUrl   String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  externalId String?
  family     Family    @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@unique([familyId, externalId])
  @@index([familyId])
}

model FamilyInvite {
  id            String    @id @default(uuid())
  familyId      String
  email         String
  displayEmail  String
  invitedById   String
  invitedByName String?
  status        String    @default("pending")
  createdAt     DateTime  @default(now())
  expiresAt     DateTime?
  family        Family    @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@unique([familyId, email])
  @@index([email])
  @@index([familyId])
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  familyId  String?
  type      String
  title     String
  body      String
  priority  String   @default("normal")
  data      Json?
  actionUrl String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  family    Family?  @relation(fields: [familyId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([familyId])
  @@index([userId, read])
  @@index([createdAt])
}

model NotificationPreferences {
  id                       String   @id @default(uuid())
  userId                   String   @unique
  expenseNotifications     Boolean  @default(true)
  swapRequestNotifications Boolean  @default(true)
  taskNotifications        Boolean  @default(true)
  calendarNotifications    Boolean  @default(true)
  chatNotifications        Boolean  @default(true)
  emailNotifications       Boolean  @default(true)
  pushNotifications        Boolean  @default(true)
  quietHoursEnabled        Boolean  @default(false)
  quietHoursStart          String?
  quietHoursEnd            String?
  updatedAt                DateTime @updatedAt
  user                     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model UserSettings {
  id         String   @id @default(uuid())
  userId     String   @unique
  language   String   @default("en")
  timezone   String   @default("UTC")
  dateFormat String   @default("MM/DD/YYYY")
  timeFormat String   @default("12h")
  weekStart  String   @default("sunday")
  theme      String   @default("auto")
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model FamilySettings {
  id                         String   @id @default(uuid())
  familyId                   String   @unique
  defaultCurrency            String   @default("USD")
  expenseSplitDefault        String   @default("equal")
  parent1Percentage          Int      @default(50)
  parent2Percentage          Int      @default(50)
  requireApprovalForExpenses Boolean  @default(true)
  expenseApprovalThreshold   Float?
  allowSwapRequests          Boolean  @default(true)
  requireApprovalForSwaps    Boolean  @default(true)
  reminderDefaultTime        String   @default("09:00")
  enableCalendarReminders    Boolean  @default(true)
  calendarReminderMinutes    Int      @default(30)
  updatedAt                  DateTime @updatedAt
  family                     Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@index([familyId])
}

model PrivacySettings {
  id                         String   @id @default(uuid())
  userId                     String   @unique
  profileVisibility          String   @default("family")
  shareCalendarWithCoParent  Boolean  @default(true)
  shareExpensesWithCoParent  Boolean  @default(true)
  shareDocumentsWithCoParent Boolean  @default(true)
  allowCoParentMessaging     Boolean  @default(true)
  blockedUserIds             String[] @default([])
  updatedAt                  DateTime @updatedAt
  user                       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model CustodySchedule {
  id                     String                  @id @default(uuid())
  familyId               String                  @unique
  name                   String?
  pattern                String
  startDate              DateTime
  endDate                DateTime?
  parent1Days            Int[]
  parent2Days            Int[]
  biweeklyAltParent1Days Int[]                   @default([])
  biweeklyAltParent2Days Int[]                   @default([])
  isActive               Boolean                 @default(true)
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  pendingApproval        CustodyApprovalRequest?
  family                 Family                  @relation(fields: [familyId], references: [id], onDelete: Cascade)
}

model CustodyApprovalRequest {
  id              String          @id @default(uuid())
  scheduleId      String          @unique
  name            String?
  pattern         String
  startDate       DateTime
  parent1Days     Int[]
  parent2Days     Int[]
  requestedById   String?
  requestedByName String?
  requestedAt     DateTime        @default(now())
  schedule        CustodySchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
}

model CustodyOverride {
  id              String    @id @default(uuid())
  familyId        String
  name            String?
  type            String
  startDate       DateTime
  endDate         DateTime
  assignments     Json
  note            String?
  status          String    @default("pending")
  requestedById   String
  requestedByName String?
  requestedToId   String?
  requestedToName String?
  responseNote    String?
  respondedById   String?
  respondedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  family          Family    @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@index([familyId])
  @@index([familyId, status])
  @@index([familyId, startDate, endDate])
}

model CalendarEvent {
  id              String         @id @default(uuid())
  familyId        String
  title           String
  description     String?
  startDate       DateTime
  endDate         DateTime
  type            String         // custody, pickup, dropoff, school, activity, medical, holiday, vacation, birthday, other
  parentId        String
  targetUids      String[]       @default([])
  color           String?
  location        String?
  reminderMinutes Int?
  isAllDay        Boolean        @default(false)
  childId         String?
  swapRequestId   String?
  recurring       Json?          // { frequency: 'yearly' | 'monthly' | 'weekly', endDate?: DateTime, daysOfWeek?: number[] }
  createdById     String?
  createdByName   String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  createdBy       User?          @relation("EventCreator", fields: [createdById], references: [id])
  family          Family         @relation(fields: [familyId], references: [id], onDelete: Cascade)
  reminder        EventReminder?

  @@index([familyId])
  @@index([familyId, startDate])
  @@index([swapRequestId])
}

model EventReminder {
  id         String        @id @default(uuid())
  eventId    String        @unique
  familyId   String
  title      String
  startDate  DateTime
  sendAt     DateTime
  sent       Boolean       @default(false)
  sentAt     DateTime?
  targetUids String[]      @default([])
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  event      CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  family     Family        @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@index([sent, sendAt])
  @@index([familyId])
}

model Expense {
  id                    String    @id @default(uuid())
  familyId              String
  title                 String
  amount                Float
  date                  DateTime
  notes                 String?
  receiptUrl            String?
  receiptName           String?
  splitParent1          Int       @default(50)
  status                String    @default("pending")
  isPaid                Boolean   @default(false)
  createdById           String
  createdByName         String?
  updatedById           String?
  updatedByName         String?
  // Rejection/Appeal fields
  rejectionNote         String?
  appealNote            String?
  appealRequestedById   String?
  appealRequestedByName String?
  appealRequestedAt     DateTime?
  appealResponseNote    String?
  appealRespondedById   String?
  appealRespondedByName String?
  appealRespondedAt     DateTime?
  // Timestamps
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  createdBy             User      @relation("ExpenseCreator", fields: [createdById], references: [id], onDelete: Cascade)
  family                Family    @relation(fields: [familyId], references: [id], onDelete: Cascade)
  updatedBy             User?     @relation("ExpenseUpdater", fields: [updatedById], references: [id])

  @@index([familyId])
  @@index([familyId, date])
  @@index([familyId, status])
}

model FinanceSettings {
  id                     String         @id @default(uuid())
  familyId               String         @unique
  alimonyAmount          Float          @default(0)
  alimonyPayer           String?
  defaultSplitParent1    Int            @default(50)
  updatedAt              DateTime       @updatedAt
  autoCalculateSplit     Boolean        @default(true)
  defaultExpenseCategory String?
  enableReceiptScanning  Boolean        @default(true)
  paymentReminderDays    Int            @default(7)
  sendPaymentReminders   Boolean        @default(true)
  trackPaymentStatus     Boolean        @default(true)
  family                 Family         @relation(fields: [familyId], references: [id], onDelete: Cascade)
  fixedExpenses          FixedExpense[]
}

model FixedExpense {
  id           String          @id @default(uuid())
  settingsId   String
  title        String
  amount       Float
  splitParent1 Int
  settings     FinanceSettings @relation(fields: [settingsId], references: [id], onDelete: Cascade)

  @@index([settingsId])
}

model Task {
  id            String    @id @default(uuid())
  familyId      String
  title         String
  description   String?
  dueDate       DateTime?
  priority      String    @default("medium")
  status        String    @default("pending")
  assignedTo    String    @default("both")
  category      String    @default("other")
  childId       String?
  createdById   String
  createdByName String?
  completedAt   DateTime?
  completedById String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  completedBy   User?     @relation("TaskCompleter", fields: [completedById], references: [id])
  createdBy     User      @relation("TaskCreator", fields: [createdById], references: [id], onDelete: Cascade)
  family        Family    @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@index([familyId])
  @@index([familyId, status])
  @@index([familyId, dueDate])
}

model Document {
  id             String   @id @default(uuid())
  familyId       String
  title          String
  fileName       String
  fileUrl        String
  fileSize       Int?
  mimeType       String?
  childId        String?
  uploadedById   String?
  uploadedByName String?
  uploadedAt     DateTime @default(now())
  family         Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)
  uploadedBy     User?    @relation("DocumentUploader", fields: [uploadedById], references: [id])

  @@index([familyId])
  @@index([familyId, childId])
}

model SwapRequest {
  id                   String    @id @default(uuid())
  familyId             String
  requestedById        String
  requestedByName      String?
  requestedToId        String
  requestedToName      String?
  originalDate         DateTime
  proposedDate         DateTime?
  requestType          String    @default("swap")
  reason               String?
  status               String    @default("pending")
  responseNote         String?
  respondedAt          DateTime?
  createdAt            DateTime  @default(now())
  counterNote          String?
  counterRespondedAt   DateTime?
  counterResponseNote  String?
  counteredAt          DateTime?
  counteredById        String?
  previousProposedDate DateTime?
  requesterConfirmedAt DateTime?
  family               Family    @relation(fields: [familyId], references: [id], onDelete: Cascade)
  requestedBy          User      @relation("SwapRequester", fields: [requestedById], references: [id], onDelete: Cascade)
  requestedTo          User      @relation("SwapResponder", fields: [requestedToId], references: [id], onDelete: Cascade)

  @@index([familyId])
  @@index([familyId, status])
  @@index([requestedById])
  @@index([requestedToId])
}

model PaymentReceipt {
  id             String   @id @default(uuid())
  familyId       String
  month          Int
  year           Int
  imageUrl       String
  imageName      String?
  amount         Float?
  paidTo         String
  description    String?
  uploadedById   String
  uploadedByName String?
  createdAt      DateTime @default(now())
  family         Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)
  uploadedBy     User     @relation("PaymentReceiptUploader", fields: [uploadedById], references: [id], onDelete: Cascade)

  @@index([familyId])
  @@index([familyId, year, month])
}

model ChatMessage {
  id          String    @id @default(uuid())
  familyId    String
  senderId    String
  senderName  String?
  text        String?
  imageData   String?
  imageWidth  Int?
  imageHeight Int?
  edited      Boolean   @default(false)
  editedAt    DateTime?
  deleted     Boolean   @default(false)
  deletedAt   DateTime?
  sentAt      DateTime  @default(now())
  family      Family    @relation(fields: [familyId], references: [id], onDelete: Cascade)
  sender      User      @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([familyId, sentAt])
  @@index([senderId])
}

model GoalTable {
  id        String          @id @default(uuid())
  familyId  String
  childId   String
  childName String
  title     String
  startDate DateTime
  endDate   DateTime
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  progress  DailyProgress[]
  goals     Goal[]
  family    Family          @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@index([familyId])
  @@index([familyId, childId])
  @@index([familyId, startDate, endDate])
}

model Goal {
  id          String    @id @default(uuid())
  goalTableId String
  title       String
  icon        String?
  order       Int       @default(0)
  goalTable   GoalTable @relation(fields: [goalTableId], references: [id], onDelete: Cascade)

  @@index([goalTableId])
}

model DailyProgress {
  id                   String    @id @default(uuid())
  goalTableId          String
  date                 DateTime
  completedGoals       String[]
  notes                String?
  completionPercentage Int       @default(0)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  goalTable            GoalTable @relation(fields: [goalTableId], references: [id], onDelete: Cascade)

  @@unique([goalTableId, date])
  @@index([goalTableId, date])
}

model MonthlyExpenseSummary {
  id            String   @id @default(uuid())
  familyId      String
  month         Int
  year          Int
  label         String
  totalApproved Float    @default(0)
  parent1Share  Float    @default(0)
  parent2Share  Float    @default(0)
  approvedCount Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  family        Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@unique([familyId, year, month])
  @@index([familyId])
  @@index([familyId, year])
}

model Contact {
  id        String   @id @default(uuid())
  familyId  String
  childId   String?
  name      String
  phone     String?
  email     String?
  category  String   @default("other")
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  family    Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@index([familyId])
  @@index([familyId, childId])
  @@index([familyId, category])
}
